version: 0.2

env:
  variables:
    PACKAGE_PREFIX: "Packages/DeimosCore"

phases:
  install:
    runtime-versions:
      python: 3.7
    commands:

      # Upgrade AWS CLI to the latest version
      - pip install --upgrade awscli
  pre_build:
    commands:
      - echo --- Fetching AWS Key Information --
      - which aws
      - export KMS_S3KEY=`/usr/local/bin/aws kms describe-key --key-id alias/aws/s3 --query 'KeyMetadata.KeyId'`
      - echo --- Validating Cloudformation Templates ---
      - aws cloudformation validate-template --template-body file://cf-deimos.json
      - echo --- Validating Cloudformation Resources ---
      - aws cloudformation validate-template --template-body file://Resources/DeimosVPN.json
      - aws cloudformation validate-template --template-body file://Resources/Templates/SubnetGroup.json
  build: 
    commands:
      - echo --- Packaging Lambda Functions ---
      - mkdir -p Resources/Lambda
      - PKGROOT=`pwd`
      - cd ${PKGROOT}/Lambda/OnDemandNAT
      - zip -r ${PKGROOT}/Resources/Lambda/OnDemandNAT.zip *
      - cd ${PKGROOT}/Lambda/VPNLaunchedHandler
      - zip -r ${PKGROOT}/Resources/Lambda/VPNLaunchedHandler.zip *
artifacts:
  secondary-artifacts:
    DeimosCloudFormation:
      base-directory: ./
      files:
        - cf-deimos.json
    DeimosResources:
      base-directory: Resources
      files:
        - '**/*'
        
    
