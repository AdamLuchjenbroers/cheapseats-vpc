{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description" : "VPN Access Infrastructure",
  
  "Parameters" : {
    "VpnCIDRRange" : {
      "Type" : "String",
      "Description" : "CIDR Range for Incoming VPN Connectivity"
    }, 
    "ConfigBucket" : {
       "Type" : "AWS::SSM::Parameter::Value<String>",
       "Description" : "S3 Bucket for Configuration Artifacts & Templates",
       "Default" : "/Deimos/ConfigBucket"
    },
    "VPCName" : {
      "Type" : "String" ,
      "Description" : "Environment Name for VPC and Supporting Infrastructure",
      "Default" : "Deimos"
    },  
    "VpcId" : {
      "Type" : "String",
      "Description" : "VPC ID of VPC",
      "Default" : "vpc-09731938fa88bc566"
    },
    "BaseAMI" : {
      "Type" : "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>",
      "Description" : "Base AMI for VPN Server Instance",
      "Default" : "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"
    }
  },
  
  "Resources" : {
    "VPNServerSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Security Group for VPN Hosts",
        "GroupName" :  { "Fn::Sub" : "${VPCName}-VPN-SecurityGroup" },
        "SecurityGroupIngress" : [ {
          "IpProtocol" : "tcp",
          "FromPort" : 22,
          "ToPort" : 22,
          "CidrIp" : "0.0.0.0/0"
         } ],
        "VpcId" : { "Ref" : "VpcId" }
      }
    },
    
   "VPNCidrRange" : {
      "Type" : "AWS::SSM::Parameter",
      "Properties" : {
        "Name" : { "Fn::Sub" : "/${VPCName}/VPN/HomeNetworkCIDR" },
        "Type" : "String",
        "Description" : "CIDR range for connected VPN clients",
        "Value" : { "Ref" : "VpnCIDRRange" }
      }
   },
    
    "VPNServerLaunchTemplate" : {
      "Type" : "AWS::EC2::LaunchTemplate",
      "Properties" : {
        "LaunchTemplateName" : { "Fn::Sub" : "${VPCName}-VPN-LaunchTemplate" },
        "LaunchTemplateData" : {
          "ImageId" : { "Ref" : "BaseAMI" },
          "InstanceType" : "t3.nano",
          "CreditSpecification" : {
            "CpuCredits" : "unlimited"
          },
          "BlockDeviceMappings" : [ 
            { 
              "DeviceName" : "/dev/xvda",
              "Ebs" : {
                "VolumeSize" : 20,
                "VolumeType" : "gp2"
              }
            }
          ],
          "NetworkInterfaces" : [
            {
              "AssociatePublicIpAddress" : "true",
              "Groups" : [ { "Ref" : "VPNServerSecurityGroup" } ],
              "DeviceIndex" : 0
            }
          ],
          "KeyName" : "Deimos-Administration",
          "TagSpecifications" : [
            { 
              "ResourceType" : "instance",
              "Tags" : [
                { "Key" : "Name", "Value" : "VPNHost" }
              ] 
            }
          ]
        }
      }
    },
    
    "VPNLaunchNotificationTopic" : {
      "Type" : "AWS::SNS::Topic",
      "Properties" : {
        "TopicName" : { "Fn::Sub" : "${VPCName}-VPN-LaunchNotification" }
      }
    },
    
    "AutoScalingGroup" : {
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : {
        "AutoScalingGroupName" : { "Fn::Sub" : "${VPCName}-VPN" },
        "VPCZoneIdentifier" : { "Fn::Split" : [ ",",  { "Fn::ImportValue" : { "Fn::Sub" : "${VPCName}-Public-Subnets" } } ] },
        "MinSize" : 0,
        "MaxSize" : 1,
        "DesiredCapacity" : 0,
        "HealthCheckGracePeriod" : 300,
        "LaunchTemplate" : {
          "LaunchTemplateId" : { "Ref":"VPNServerLaunchTemplate" },
          "Version" : { "Fn::GetAtt" : [ "VPNServerLaunchTemplate", "LatestVersionNumber" ] }
        },
        "NotificationConfigurations" : [
          {
            "NotificationTypes" : [
              "autoscaling:EC2_INSTANCE_LAUNCH",
              "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
              "autoscaling:EC2_INSTANCE_TERMINATE",
              "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
            ],
            "TopicARN" : { "Ref" : "VPNLaunchNotificationTopic" } 
          }
        ]
      }
    },
    
    "VpnLaunchHandlerRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [ {
            "Effect" : "Allow",
            "Principal" : {
              "Service" : [ "lambda.amazonaws.com" ]
            },
            "Action" : [ "sts:AssumeRole" ]
          } ]
        },
        "RoleName" : "DeimosVpn-LaunchHandlerRole",
        "Path" : "/deimosvpn/",
        "ManagedPolicyArns" : [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        ]
      }
    },
    
    "VpnLaunchHandlerPolicy" : {
      "DependsOn" : [ "VpnLaunchHandlerRole" ],
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyName" : "DeimosVpn-LaunchHandlerPolicy",
        "Roles" : [ { "Ref" : "VpnLaunchHandlerRole" } ],
        "PolicyDocument" : {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "VPNUpdateRouting",
              "Effect": "Allow",
              "Action": [
                "ec2:DescribeInstances",
                "ec2:DescribeTags",
                "ec2:DeleteRoute",
                "ec2:CreateTags",
                "ec2:ReplaceRoute",
                "ec2:CreateRoute",
                "ec2:DescribeRouteTables",
                "ec2:ModifyInterfaceAttribute",
                "ec2:ModifyNetworkInterfaceAttribute"
              ],
              "Resource": "*"
            },
            {
              "Effect": "Allow",
              "Action": [
                "xray:PutTraceSegments",
                "xray:PutTelemetryRecords"
              ],
              "Resource": [ "*" ]
            },
            {  
              "Effect": "Allow",
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter"
              ],
              "Resource" : [
                { "Fn::Sub" : "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${VPCName}/VPN/*" }
              ]
            }
          ]
        }
      }
    },
    
    "VpnLaunchHandlerLambda" : {
      "Type" : "AWS::Lambda::Function",
      "Properties" : {
       "FunctionName" : { "Fn::Sub" : "${VPCName}-VPNLaunchHandler" },
       "Description" : "Updates Routing and Network Configuration when a VPN Host is stopped or started",
       "Code" : {
         "S3Bucket" : { "Ref" : "ConfigBucket" },
         "S3Key" : "Resources/Lambda/VPNLaunchedHandler.zip"
       },
       "Handler" : "VPNLaunchedHandler.notification_handler",
       "Runtime" : "python3.6",
       "Timeout" : 300,
       "Role"    : { "Fn::GetAtt" : [ "VpnLaunchHandlerRole", "Arn" ] },
       "Environment" : { 
         "Variables" : {
           "VPC_ID" : { "Ref" : "VpcId" },
           "VPC_NAME" : { "Ref" : "VPCName" }
         }
       }
     }
   },
    
    "VpnLaunchHandlerSubscription" : {
      "Type" : "AWS::SNS::Subscription",
      "Properties" : {
        "Protocol" : "lambda",
        "Endpoint" : { "Fn::GetAtt" : [ "VpnLaunchHandlerLambda", "Arn" ] },
        "TopicArn" : { "Ref" : "VPNLaunchNotificationTopic" }
      }
    },    
   
    "VpnLaunchSubscriptionPermission" : {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "Action": "lambda:invokeFunction",
        "FunctionName": {"Fn::GetAtt": ["VpnLaunchHandlerLambda", "Arn"]},
        "Principal": "sns.amazonaws.com",
        "SourceArn": { "Ref" : "VPNLaunchNotificationTopic" }
      }
    }
  }
}
