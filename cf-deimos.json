{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description" : "Core Deimos VPC and IAM Infrastructure",
  
  "Parameters" : {
    "AwsCIDRRange" : {
      "Type" : "String",
      "Description" : "CIDR Range for AWS Resources"
    },
    "VpnCIDRRange" : {
      "Type" : "String",
      "Description" : "CIDR Range for Incoming VPN Connectivity"
    },
    "ConfigBucket" : {
       "Type" : "AWS::SSM::Parameter::Value<String>",
       "Description" : "Deimos Configuration Bucket",
       "Default" : "/Deimos/ConfigBucket"
    }
  },
  
  "Resources" : {
    "DeimosVpc" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : { "Ref" : "AwsCIDRRange" },
        "EnableDnsSupport" : true,
        "Tags" : [
          { "Key" : "Name", "Value" : "DeimosVPC" }
        ]       
      }
    },

    "InternetGateway" : {
      "Type" : "AWS::EC2::InternetGateway"
    },

    "IgwAttachment" : {
      "Type" : "AWS::EC2::VPCGatewayAttachment",
      "Properties" : {
        "VpcId" : { "Ref" : "DeimosVpc" },
        "InternetGatewayId" : { "Ref" : "InternetGateway" }
      }
    },

    "PublicRouteTable" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : { "Ref" : "DeimosVpc" },
        "Tags" : [
          { "Key" : "Name", "Value" : "PublicRouteTable" }
        ]       
      }
    },

    "PublicSubnets" : {
      "Type" : "AWS::CloudFormation::Stack",
      "Properties" : {
        "Parameters" : {
          "SubnetGroupName" : "Public",
          "CidrRange" : { "Fn::Select" : [ 0,  { "Fn::Cidr" : [ { "Ref" : "AwsCIDRRange" }, 2, 14 ] } ] },
          "VpcId" : { "Ref" : "DeimosVpc" },
          "MaskSize" : 8,
          "RouteTable" : { "Ref" : "PublicRouteTable" }
        },
        "TemplateURL" : { "Fn::Sub" : "https://${ConfigBucket}.s3.${AWS::Region}.amazonaws.com/Templates/SubnetGroup.json"}
      }
    },

    "PublicSubnetInternetRoute" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "IgwAttachment",
      "Properties" : {
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : { "Ref" : "InternetGateway" },
        "RouteTableId" : { "Ref" : "PublicRouteTable" }
      }
    },

    "PrivateRouteTable" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : { "Ref" : "DeimosVpc" },
        "Tags" : [
          { "Key" : "Name", "Value" : "PrivateRouteTable" }
        ]       
      }
    },

    "PrivateSubnets" : {
      "Type" : "AWS::CloudFormation::Stack",
      "Properties" : {
        "Parameters" : {
          "SubnetGroupName" : "Private",
          "CidrRange" : { "Fn::Select" : [ 1,  { "Fn::Cidr" : [ { "Ref" : "AwsCIDRRange" }, 2, 14 ] } ] },
          "VpcId" : { "Ref" : "DeimosVpc" },
          "MaskSize" : 8,
          "RouteTable" : { "Ref" : "PrivateRouteTable" }
        },
        "TemplateURL" : { "Fn::Sub" : "https://${ConfigBucket}.s3.${AWS::Region}.amazonaws.com/Templates/SubnetGroup.json"}
      }
    }
  },
  
  "Outputs" : {
    "DeimosVpcId" : {
      "Description" : "VPC ID of Deimos VPC",
      "Value" : { "Ref" : "DeimosVpc" },
      "Export" : {
        "Name" : "Deimos-VPCID"
      }
    }
  }
}
    
